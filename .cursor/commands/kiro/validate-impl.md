<meta>
description: 要件、設計、タスクに対する実装の検証
argument-hint: [feature-name:$1] [task-numbers:$2]
</meta>

# 実装検証

<background_information>
- **ミッション**: 実装が承認済み要件、設計、タスクと整合していることを検証
- **成功基準**:
  - 指定されたすべてのタスクが完了としてマーク
  - 実装された機能のテストが存在し合格
  - 要件トレーサビリティの確認（EARS要件がカバーされている）
  - 設計構造が実装に反映されている
  - 既存機能にリグレッションがない
</background_information>

<instructions>
## コアタスク
承認済み仕様に基づいて、機能とタスクの実装を検証する。

## 実行ステップ

### 1. 検証対象の検出

**引数が提供されない場合**（`$1` が空）:
- 会話履歴から `/kiro/spec-impl <feature> [tasks]` コマンドを解析
- 各実行から機能名とタスク番号を抽出
- 機能ごとに実装されたすべてのタスクを集約
- 検出された実装を報告（例: "user-auth: 1.1, 1.2, 1.3"）
- 履歴が見つからない場合、`.kiro/specs/` をスキャンして完了タスク `[x]` を持つ機能を検索

**機能が提供された場合**（`$1` あり、`$2` 空）:
- 指定された機能を使用
- `.kiro/specs/$1/tasks.md` で完了したすべてのタスク `[x]` を検出

**機能とタスクの両方が提供された場合**（`$1` と `$2` あり）:
- 指定された機能とタスクのみを検証（例: `user-auth 1.1,1.2`）

### 2. コンテキストの読み込み

検出された各機能について:
- `.kiro/specs/<feature>/spec.json` からメタデータを読み込み
- `.kiro/specs/<feature>/requirements.md` から要件を読み込み
- `.kiro/specs/<feature>/design.md` から設計構造を読み込み
- `.kiro/specs/<feature>/tasks.md` からタスクリストを読み込み
- **全ステアリングコンテキストを読み込み**: `.kiro/steering/` ディレクトリ全体を読み込み:
  - デフォルトファイル: `structure.md`, `tech.md`, `product.md`
  - すべてのカスタムステアリングファイル（モード設定に関係なく）

### 3. 検証の実行

各タスクについて以下を検証:

#### タスク完了チェック
- tasks.md でチェックボックスが `[x]` になっている
- 完了していない場合、"タスクが完了としてマークされていません" とフラグ

#### テストカバレッジチェック
- タスク関連機能のテストが存在する
- テストが合格している（失敗やエラーがない）
- Bash を使用してテストコマンドを実行（例: `npm test`, `pytest`）
- テストが失敗または存在しない場合、"テストカバレッジの問題" とフラグ

#### 要件トレーサビリティ
- タスクに関連するEARS要件を特定
- Grep を使用して要件カバレッジの証拠を実装内で検索
- 要件がコードに追跡できない場合、"要件が実装されていません" とフラグ

#### 設計整合性
- design.md の構造が実装に反映されているか確認
- 主要なインターフェース、コンポーネント、モジュールが存在するか検証
- Grep/LS を使用してファイル構造が設計と一致することを確認
- 不整合が見つかった場合、"設計との乖離" とフラグ

#### リグレッションチェック
- フルテストスイートを実行（利用可能な場合）
- 既存のテストが壊れていないことを確認
- リグレッションが検出された場合、"リグレッション検出" とフラグ

### 4. レポートの生成

spec.json で指定された言語でサマリーを提供:
- 機能ごとの検証サマリー
- カバレッジレポート（タスク、要件、設計）
- 重大度を伴う問題と乖離（重大/警告）
- GO/NO-GO 判定

## 重要な制約
- **会話認識**: 自動検出には会話履歴を優先
- **非ブロッキング警告**: 設計の乖離は重大でない限り警告
- **テストファースト重視**: テストカバレッジはGO判定に必須
- **トレーサビリティ必須**: すべての要件が実装に追跡可能でなければならない
</instructions>

## ツールガイダンス
- **会話解析**: 履歴から `/kiro/spec-impl` パターンを抽出
- **コンテキスト読み込み**: 検証前にすべてのspecとsteeringを読み込み
- **テスト用Bash**: テストコマンドを実行して合格状態を確認
- **トレーサビリティ用Grep**: 要件の証拠をコードベースで検索
- **構造用LS/Glob**: ファイル構造が設計と一致することを確認

## 出力説明

spec.json で指定された言語で以下を出力:

1. **検出対象**: 検証される機能とタスク（自動検出の場合）
2. **検証サマリー**: 機能ごとの簡潔な概要（合格/不合格数）
3. **問題**: 重大度と場所を含む検証失敗のリスト
4. **カバレッジレポート**: 要件/設計/タスクのカバレッジ率
5. **判定**: GO（次フェーズ準備完了）/ NO-GO（修正が必要）

**フォーマット要件**:
- 明確さのためMarkdown見出しと表を使用
- 重大な問題には ⚠️ または 🔴 でフラグ
- サマリーは簡潔に（400語以内）

## 安全性とフォールバック

### エラーシナリオ
- **実装が見つからない**: 履歴に `/kiro/spec-impl` がなく `[x]` タスクもない場合、"実装が検出されませんでした" と報告
- **テストコマンドが不明**: テストフレームワークが不明確な場合、警告してテスト検証をスキップ（手動検証が必要）
- **Specファイルが見つからない**: spec.json/requirements.md/design.md がない場合、エラーで停止
- **言語が未定義**: spec.json で言語が指定されていない場合、英語（`en`）をデフォルトに

### 次のステップガイダンス

**GO判定の場合**:
- 実装が検証され準備完了
- デプロイまたは次の機能へ進む

**NO-GO判定の場合**:
- リストされた重大な問題に対処
- `/kiro/spec-impl <feature> [tasks]` を再実行して修正
- `/kiro/validate-impl [feature] [tasks]` で再検証

**注記**: 検証は実装後にspec整合性と品質を確保するために推奨。
</output>
